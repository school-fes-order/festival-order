<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理画面</title>
<link rel="stylesheet" href="style.css">
<style>
/* ボタンを大きく */
button {
  font-size: 1.2em;
  padding: 12px 20px;
  margin: 5px 0;
}

/* お知らせ用 */
#notice {
  background-color: #fffae6;
  color: #ff6f61;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 8px;
  display: none; /* 初期非表示 */
  font-weight: bold;
}
</style>
</head>
<body>

<header>管理画面</header>

<section>
  <!-- お知らせ表示 -->
  <div id="notice"></div>

  <!-- 営業状態切替 -->
  <button id="toggleOpen">営業状態切替</button>
  <p id="shopStatus"></p>

  <!-- メニュー管理 -->
  <h2>メニュー管理</h2>
  <div id="menuList"></div>

  <!-- 注文一覧 -->
  <h2>注文一覧</h2>
  <div id="ordersList"></div>

  <!-- 同時アクセス人数 -->
  <p id="visitors"></p>
</section>

<script>
const API = "https://script.google.com/macros/s/AKfycbx2-ndOa2I7toHYqaSt2Dga64IrUBxj3myYIgBgMznfkazVXWII6v1WPG4wKOf_8KwYgA/exec";

let actionLocked = false;

/* お知らせ表示 */
function showNotice(msg, duration=3000){
  const notice = document.getElementById("notice");
  notice.innerText = msg;
  notice.style.display = "block";
  setTimeout(()=>{ notice.style.display="none"; }, duration);
}

/* 店の状態取得 */
async function loadShop() {
  const res = await fetch(`${API}?action=shop`);
  const data = await res.json();
  document.getElementById("shopStatus").innerText = data.isOpen ? "営業中" : "一時休止";
  if(!data.isOpen) showNotice("現在は一時休止中です");
}

/* 営業切替（連打防止） */
document.getElementById("toggleOpen").onclick = async () => {
  if(actionLocked) return;
  actionLocked = true;
  const btn = document.getElementById("toggleOpen");
  btn.disabled = true;
  btn.innerText = "処理中...";
  
  try{
    await fetch(API,{method:"POST", body:JSON.stringify({action:"toggleOpen"})});
    loadShop();
    showNotice("営業状態を切り替えました");
  }catch(e){
    showNotice("送信に失敗しました");
  }
  
  btn.disabled = false;
  btn.innerText = "営業状態切替";
  actionLocked = false;
};

/* メニュー管理 */
async function loadMenu() {
  const res = await fetch(`${API}?action=menu`);
  const menu = await res.json();
  const div = document.getElementById("menuList");
  div.innerHTML = "";
  menu.forEach((m,index)=>{
    const itemDiv = document.createElement("div");
    itemDiv.className = "menu-item";
    itemDiv.innerHTML = `${m.name} (${m.soldout?"売り切れ":"販売中"})
      <button data-name="${m.name}">切替</button>`;
    itemDiv.querySelector("button").onclick = async e=>{
      if(actionLocked) return;
      actionLocked = true;
      const btn = e.target;
      btn.disabled = true;
      btn.innerText = "処理中...";
      try{
        await fetch(API,{method:"POST",body:JSON.stringify({action:"toggleSoldout", name:btn.dataset.name})});
        loadMenu();
        showNotice(`${btn.dataset.name} の売り切れ状態を切替ました`);
      }catch(e){
        showNotice("送信に失敗しました");
      }
      btn.disabled = false;
      btn.innerText = "切替";
      actionLocked = false;
    };
    div.appendChild(itemDiv);
    setTimeout(()=>itemDiv.classList.add("show"), index*100);
  });
}

/* 注文一覧表示 */
async function loadOrders() {
  const res = await fetch(`${API}?action=orders`);
  const orders = await res.json();
  const div = document.getElementById("ordersList");
  div.innerHTML = "";
  orders.forEach(o=>{
    const d = document.createElement("div");
    d.innerHTML = `ID:${o.id} - ${o.items.map(i=>i.name).join(", ")} - ${o.status}`;
    div.appendChild(d);
  });
}

/* 同時アクセス人数 */
function getVisitorCount(){
  const userId = localStorage.getItem("visitorId") || Date.now().toString() + Math.random();
  localStorage.setItem("visitorId", userId);
  fetch(API, {
    method:"POST",
    body: JSON.stringify({action:"trackVisitor",userId})
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("visitors").innerText = `現在アクセス中: ${data.count}人`;
  });
}

/* 初期表示 */
loadShop();
loadMenu();
loadOrders();
getVisitorCount();

/* 定期更新 */
setInterval(()=>{
  loadShop();
  loadMenu();
  loadOrders();
  getVisitorCount();
},5000);

</script>
</body>
</html>
